---
title: "Assignment 3"
author: "JIANG RUI Chan Yat Tin"
date: '2022-05-12'
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Loading packages
```{r}
# install.packages("stargazer")
suppressMessages(library(AER))
library(stargazer)
library(hdm)
data("Affairs")
?Affairs
```

```{r}
Affairs$happy=(Affairs$rating==5)
Affairs$Cheater=(Affairs$affairs==12)
Affairs$age2=Affairs$age^2
Affairs$yearsmarried2=Affairs$yearsmarried^2
summary(Affairs)
```

# Part A
```{r}
ct <- lm(formula=Cheater~happy+gender+age+age2+children+as.factor(religiousness)+education+as.factor(occupation), data=Affairs)
ct
a<-as.data.frame(ct$coefficients)

# Compute heteroskedasticity-robust standard errors and significance levels, where NAME is the name of a regression-type object created by lm() and other similar commands
ROBUST <- coeftest(ct,vcov=vcovHC(ct, type = "HC0"))
ROBUST
happy_coef <- as.character(ROBUST[2,1])
happy_se <- as.character(ROBUST[2,2])

# report the 90% confidence interval for the estimated coefficient of happy, where ROBUST is the name of the object created by the coeftest() command above
all_result <- confint(ROBUST, level=0.90)
all_result
# select happy result 
happy_df <- as.data.frame(all_result[2,])
happy_df[2,1]
happy_90_ci <- paste("[",as.character(happy_df[1,1]),",",as.character(happy_df[2,1]),"]",sep="")
happy_90_ci

# cbind
table <- cbind(happy_coef,happy_se,happy_90_ci)
colnames(table) <- c("happy coefficient", "happy SE", "happy 90% CI")

# present result in stargazer command 
stargazer(table, type="text", title="Summary of Part A")
```

1. What is the estimated effect of happy on the probability of having regular affairs?
Ans: Being very satisfied with marriages is expected to reduce the probability of having regular affairs by 0.0315.

2. Is the estimated effect significant?
Ans: Since the p-value is 0.090841 > 0.05, the estimated effect is statistically insignificant. 

3. Does the sign of estimated effect makes sense?
Ans: Yes. If you have a happy marriage, you are less likely to find partners outside and thus have affairs.


4. Comment on the magnitude of the effect: does it make sense?
Ans: From my perspective, the magnitude is drastically less than expected because marriage satisfaction should be one of the major factors dissuading people from having affairs.  

# Part B
```{r}
iv <- ivreg(Cheater~happy+gender+age+age2+children+as.factor(religiousness)+education+as.factor(occupation) | yearsmarried + yearsmarried2 + (yearsmarried+yearsmarried2)*( gender + age + age2 + children + as.factor(religiousness)+education+as.factor(occupation) ), data=Affairs)
iv
iv_ROBUST <- coeftest(iv,vcov=vcovHC(iv, type = "HC0"))
iv_ROBUST
iv_ROBUST[2,1]
iv_ROBUST[2,2]

happy_df_b <- as.data.frame(confint(iv_ROBUST,level=0.90)[2,])
happy_90_ci_b <- paste("[",as.character(happy_df_b[1,1]),",",as.character(happy_df_b[2,1]),"]",sep="")

# First stage
first_stage <- lm(happy~yearsmarried + yearsmarried2 + (yearsmarried+yearsmarried2)*( gender + age + age2 + children + as.factor(religiousness)+education+as.factor(occupation)) , data=Affairs)
first_stage_robust <- coeftest(first_stage, type="HC0")
first_stage_robust
```

# Part c
```{r}
lasso.iv <- rlassoIV(Cheater~happy+gender+age+age2+children+as.factor(religiousness)+education+as.factor(occupation) | yearsmarried + yearsmarried2 + (yearsmarried+yearsmarried2)*( gender + age + age2 + children + as.factor(religiousness)+education+as.factor(occupation) ), data=Affairs,select.X=TRUE,select.Z=TRUE)

# post lasso estimates
summary(lasso.iv)
lasso.iv$coefficients
lasso.iv$se

# 90% CI
lasso.iv.ci <- confint(lasso.iv,level=0.90)
happy_90_ci_c <- paste("[",as.character(-0.8310902),",",as.character(-0.1418015),"]",sep="")

# Second stage
Second <- rlasso(Cheater~happy+gender+age+age2+children+as.factor(religiousness)+education+as.factor(occupation),data=Affairs )
second_var <- which(Second$index==TRUE)
second_var

# First stage
First <- rlasso(happy~yearsmarried + yearsmarried2 + (yearsmarried+yearsmarried2)*( gender + age + age2 + children + as.factor(religiousness)+education+as.factor(occupation) ), data=Affairs)
which(First$index==TRUE)
```

Part d
```{r}
happy_coef_ptd <- cbind(happy_coef, iv_ROBUST[2,1], lasso.iv$coefficients)
happy_se_ptd <- cbind(happy_se, iv_ROBUST[2,2], lasso.iv$se)
happy_ci_ptd <- cbind(happy_90_ci,happy_90_ci_b,happy_90_ci_c) 
happy_summary <- rbind(happy_coef_ptd, happy_se_ptd, happy_ci_ptd)
colnames(happy_summary) <- c("Part A", "Part B", "Part C")
rownames(happy_summary) <- c("Happy Coefficient", "SE", "90% CI")
```


